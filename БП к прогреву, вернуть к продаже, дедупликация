<?php

namespace Advina\Bitrix\Service;

use Advina\CRest;
use Advina\Gate\Ajax;
use Advina\Gate\Result;
use Advina\Lib;
use Advina\SUtils;
use Bitrix\Iblock\Elements\ElementChatbotOLTable;
use Bitrix\Main\Entity\DataManager;
use Bitrix\Main\Loader;
use DateInterval;
use DateTime;
use stdClass;
use Bitrix\Highloadblock as HL;

class Warming extends Base
{
    /**
     * Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°.
     *
     * @var array
     */
    protected const METHODS = [
        'goToWarm'                    => 'goToWarm',
        'goToSale'                    => 'goToSale',
        'deDuplicator'                => 'deDuplicator',
        'ElementChatbotOLTable'       => 'ElementChatbotOLTable',
    ];
    protected const QUEUE_ID = 18; // id Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾Ğ¹ Ğ»Ğ¸Ğ½Ğ¸Ğ¸
    protected const SAVED_CATEGORY_FIELD = 'UF_CRM_1685358723';
    protected const ARCHIVIST_ID = 20634; // id ĞÑ€Ñ…Ğ¸Ğ²Ğ°Ñ€Ğ¸ÑƒÑĞ°

    protected function goToWarm(): Result
    {
        if (!$this->_checkGetParamDefined('deal', 'Deal')) {
            return $this->result;
        }

        CRest::call('crm.deal.update', [ // Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ½ĞµÑÑ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ·?
            'id' => $this->deal_id,
            'fields' => [
                self::SAVED_CATEGORY_FIELD => $this->deal['CATEGORY_ID'], // 12 Ğ²Ğ¾Ñ€Ğ¾Ğ½ĞºĞ° Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµĞ² ?
            ],
            'params' => [
                'REGISTER_SONET_EVENT' => 'N',
            ]
        ]); // Ğ¿ĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ğ¼ ÑĞ´ĞµĞ»ĞºÑƒ Ğ² Ğ²Ğ¾Ñ€Ğ¾Ğ½ĞºÑƒ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµĞ²Ğ°

        Lib::runBizProc('deal', $this->deal_id, 202);
        Loader::includeModule('iblock');

        if (isset($this->deal_id)) {
             CRest::call('crm.activity.list', [ // Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ñ‡Ğ°Ñ‚Ñ‹ Ğ¸ Ğ¸Ñ… id
                'order' => ["ID", "DESC"], // ASC
                'filter' => [
                    'OWNER_TYPE_ID' => 2,// 2 ÑÑ‚Ğ¾ deal
                    'OWNER_ID' => $this->deal_id,
                    'COMPLETED' => 'N', // Ğ¸Ñ‰ĞµĞ¼ ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ ĞĞ• Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¼ Ñ‡Ğ°Ñ‚Ğ°Ğ¼
                ],
                'select' => ['*', 'COMMUNICATIONS'] // 'COMMUNICATIONS' Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğº * ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ
            ]);

            $dialogs = ElementChatbotOLTable::getList([ // Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ¸Ğ· Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°Ñ€Ğ¸ÑƒÑĞ°
                'select' => [
                    'ID',
                    'IBLOCK_ID',
                    'NAME',
                    'dialog_id_' => 'dialog_id',
                    'contact_id_' => 'contact_id',
                    'deal_id_' => 'deal_id',
                ],
                'filter' => [
                    'contact_id.value' => $this->contact['ID'],
                ]
            ])->fetchAll();

            foreach ($dialogs as $key => $value) {  // Ğ¿Ğ¾Ğ¸Ñ‰ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ CRM_CHAT_EMPTY_CRM_DATA
                $wrongDeal[] = CRest::call('imopenlines.crm.chat.getLastId', [
                    'CRM_ENTITY_TYPE' => 'DEAL',
                    'CRM_ENTITY' => $value['deal_id_VALUE'],
                ]);
            }

            foreach ($wrongDeal as $key => $value) { // ÑĞ´ĞµĞ»Ğ°ĞµĞ¼ Ğ¼Ğ°ÑÑĞ¸Ğ² ÑĞ¾ ÑĞ´ĞµĞ»ĞºĞ°Ğ¼Ğ¸ Ğ±ĞµĞ· Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
                if (!$value['error']) {
                    $chatToWrite = $value;
                    break;
                }
            }

            $userName = CRest::call('imopenlines.dialog.get', [ // Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ
                'DIALOG_ID' => $dialogs[0]['dialog_id_VALUE'],
            ]);

            CRest::call('imopenlines.session.join', [ // Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°Ñ€Ğ¸ÑƒÑĞ° Ğ² Ñ‡Ğ°Ñ‚
                'CHAT_ID' => $chatToWrite['result'],
            ]);

            CRest::call('im.chat.user.add', [ // Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°Ñ€Ğ¸ÑƒÑĞ°
                'CHAT_ID' => $chatToWrite['result'],
                'USERS' => self::ARCHIVIST_ID,
                'HIDE_HISTORY' => 'N',
            ]);

            CRest::call('imbot.message.add', [
                'DIALOG_ID' => 'chat' . $chatToWrite['result'],  // Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ² Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚
                'MESSAGE' => 'Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ, ' . $userName['result']['readed_list']['0']['user_name'] . '. Ğ’Ğ¸Ğ´Ğ¸Ğ¼, Ñ‡Ñ‚Ğ¾ Ğ’Ñ‹ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑĞ¾Ğ²Ğ°Ğ»Ğ¸ÑÑŒ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒÑ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° Ğ¸ Ñ…Ğ¾Ñ‚ĞµĞ»Ğ¸ ÑĞ¾Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·. ĞšĞ°Ğº Ğ½Ğ°ÑÑ‡ĞµÑ‚ Ñ‚Ğ¾Ğ³Ğ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ? ğŸ˜Š',
                'SYSTEM' => 'N',
            ]);

            foreach ($dialogs as $key => $valueTwo) {                               // Ğ¿Ñ€Ğ¾Ğ±ĞµĞ¶Ğ¸Ğ¼ÑÑ Ğ¿Ğ¾ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°Ğ¼
                CRest::call('imopenlines.operator.transfer', [               // Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ´Ğ¸Ğ¼ Ğ²ÑĞµ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
                    'CHAT_ID' => substr($dialogs[$key]['dialog_id_VALUE'],4), // Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°; ÑÑ‚Ğ¾ Ğ»Ğ¸Ğ±Ğ¾ USER_ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ»Ğ¸Ğ±Ğ¾ chatXX - Ğ³Ğ´Ğµ XX Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ñ‡Ğ°Ñ‚Ğ°, Ğ¿ĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ÑÑ Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¸ ONIMBOTMESSAGEADD Ğ¸ ONIMJOINCHAT
                    'TRANSFER_ID' => 'queue' . self::QUEUE_ID,
                    'SYSTEM' => 'N',
                ]);
            }
        }
        return $this->result->set([]);
    }
    protected function goToSale(): Result
    {
        $QUEUE_IDS = [
            '0' => '12',
            '2' => '6',
            '4' => '6',
        ];

        if (!$this->_checkGetParamDefined('deal', 'Deal')) {
            return $this->result;
        }

        Lib::runBizProc('deal', $this->deal_id, 204);
        Loader::includeModule('iblock');

        $dialogs = ElementChatbotOLTable::getList([
            'select' => [
                'ID',
                'IBLOCK_ID',
                'NAME',
                'dialog_id_' => 'dialog_id',
                'contact_id_' => 'contact_id',
                'deal_id_' => 'deal_id',
            ],
            'filter' => [
                'DEAL_ID.VALUE' => $this->deal_id,
            ]
        ])->fetchAll();

        if (isset($QUEUE_IDS[$this->deal[self::SAVED_CATEGORY_FIELD]])) {
            foreach ($dialogs as $dialog) {
                $dialogCut = $dialog['dialog_id_VALUE'];
                $dialogCut = substr($dialogCut, 4);
                $result = CRest::call('imopenlines.operator.transfer', array(
                    'CHAT_ID' => $dialogCut,
                    'TRANSFER_ID' => 'queue' . $QUEUE_IDS[$this->deal[self::SAVED_CATEGORY_FIELD]],
                ));
            }
        }
        return $this->result->set([]);
    }
    protected function deDuplicator(): Result {

        $result[] = CRest::call('crm.duplicate.volatileType.register', [
            'entityTypeId' => 3,
            'fieldCode' => 'UF_CRM_1694594366489',
        ]);

        $result[] = CRest::call('crm.duplicate.volatileType.list', [
            'entityTypeId' => 3,
            'fieldCode' => 'UF_CRM_1694594366489',
        ]);

        $result[] = CRest::call('crm.duplicate.volatileType.fields', [
            'entityTypeId' => 3,
            'fieldCode' => 'UF_CRM_1694594366489',
        ]);

        return $this->result->set([]);
    }
}
